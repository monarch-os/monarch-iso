#!/bin/bash

if [ $# -eq 0 ]; then
  echo "Usage: monarch-iso-release [version]"
  exit 1
fi

BUILD_ROOT=$(realpath "${BASH_SOURCE[0]%/*}/..")
BUILD_RELEASE_PATH="$BUILD_ROOT/release"
BULD_VERSION="$1"

# Make ISOs
if [[ $1 != "--no-make" ]]; then
  echo -e "\e[32mMaking master ISO\e[0m"
  MONARCH_INSTALLER_REF=master monarch-iso-make --no-cache --no-boot-offer
else
  echo -e "\e[31mSkipping remaking ISOs\e[0m"
fi

# Sign and upload master ISO
latest_master_iso=$(\ls -t "$BUILD_RELEASE_PATH"/*x86_64-master.iso | head -n1)
release_master_iso="$BUILD_RELEASE_PATH/monarch-$BULD_VERSION.iso"
cp "$latest_master_iso" "$release_master_iso"

echo -e "\e[32mSigning master ISO\e[0m"
monarch-iso-sign "$release_master_iso"

master_sha=$(sha256sum "$release_master_iso")
echo -e "\e[32mSHA256 for master ISO: $master_sha\e[0m"

monarch-iso-upload "$release_master_iso"